<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Axibase Collector | Docker Job</title>
    <meta name="description" content="User manual and API reference for Axibase® Time Series Database">
    <link rel="shortcut icon" href="/axibase-collector/favicon.ico">
    
    <link rel="stylesheet" href="/axibase-collector/assets/css/119.styles.919842c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/axibase-collector/" class="home-link router-link-active"><img src="/axibase-collector/images/axibase_logo.png" class="logo"><span class="site-name can-hide">
      Axibase Collector
    </span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Jobs</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/aws.html" class="nav-link">AWS</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/docker.html" class="nav-link router-link-exact-active router-link-active">Docker</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/file.html" class="nav-link">File</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http.html" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/icmp.html" class="nav-link">ICMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc.html" class="nav-link">JDBC</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jmx.html" class="nav-link">JMX</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/json.html" class="nav-link">JSON</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/ovpm.html" class="nav-link">OVPM</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/pi.html" class="nav-link">PI</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/snmp.html" class="nav-link">SNMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/socrata.html" class="nav-link">Socrata</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/tcp.html" class="nav-link">TCP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Data Sources</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc-data-source.html" class="nav-link">Database</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http-pool.html" class="nav-link">HTTP Pool</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka-consumer.html" class="nav-link">Kafka Consumer</a></li></ul></div></div><div class="nav-item"><a href="/axibase-collector/jobs/examples/" class="nav-link">Examples</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Jobs</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/aws.html" class="nav-link">AWS</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/docker.html" class="nav-link router-link-exact-active router-link-active">Docker</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/file.html" class="nav-link">File</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http.html" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/icmp.html" class="nav-link">ICMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc.html" class="nav-link">JDBC</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jmx.html" class="nav-link">JMX</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/json.html" class="nav-link">JSON</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/ovpm.html" class="nav-link">OVPM</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/pi.html" class="nav-link">PI</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/snmp.html" class="nav-link">SNMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/socrata.html" class="nav-link">Socrata</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/tcp.html" class="nav-link">TCP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Data Sources</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc-data-source.html" class="nav-link">Database</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http-pool.html" class="nav-link">HTTP Pool</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka-consumer.html" class="nav-link">Kafka Consumer</a></li></ul></div></div><div class="nav-item"><a href="/axibase-collector/jobs/examples/" class="nav-link">Examples</a></div><!----></nav><ul class="sidebar-links"><li><a href="/axibase-collector/jobs/docker.html" class="active sidebar-link">Docker Job</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#job-settings" class="sidebar-link">Job Settings</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#local-installation" class="sidebar-link">Local Installation</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#remote-collection" class="sidebar-link">Remote Collection</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#validation" class="sidebar-link">Validation</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#container-launch-troubleshooting" class="sidebar-link">Container Launch Troubleshooting</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#ui" class="sidebar-link">UI</a></li><li class="sidebar-sub-header"><a href="/axibase-collector/jobs/docker.html#testing-and-evaluating" class="sidebar-link">Testing and Evaluating</a></li></ul></li></ul></div><div class="page"><div class="content"><h1 id="docker-job"><a href="#docker-job" aria-hidden="true" class="header-anchor">#</a> Docker Job</h1><h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2><p>The Docker Job collects container statistics, states, and events from Docker daemons via the <a href="https://docs.docker.com/engine/reference/api/docker_remote_api/" target="_blank" rel="noopener noreferrer">Docker Engine Remote API</a>.</p><p>Information is collected for the following object types:</p><ul><li>Host</li><li>Image</li><li>Container</li><li>Volume</li><li>Network</li></ul><h2 id="job-settings"><a href="#job-settings" aria-hidden="true" class="header-anchor">#</a> Job Settings</h2><table><thead><tr><th><strong>Name</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>API Version</code></td><td>API version used when querying the Docker Engine API. Defaults to 'latest'. <br>Can be set to a specific version to ensure compatibility.</td></tr><tr><td><code>Lifecycle Event Monitoring</code></td><td>Enables continuous monitoring of container lifecycle events instead of scheduled polling.</td></tr><tr><td><code>Property Interval</code>, minutes</td><td>Interval for refreshing detailed image and container properties.</td></tr><tr><td><code>Statistics Interval</code>, seconds</td><td>Interval at which utilization statistics from running containers are collected.</td></tr><tr><td><code>Process Interval</code>, minutes</td><td>Interval at which top process list is collected from running docker containers.</td></tr><tr><td><code>Excluded Processes</code></td><td>Lists processes, separated by comma, to exclude from collection. Expressions support the wildcard option (*).</td></tr><tr><td><code>Environment Tags</code></td><td>List of ENV variables stored as entity tags.</td></tr></tbody></table><h2 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h2><ul><li><a href="https://docs.docker.com/engine/installation/" target="_blank" rel="noopener noreferrer">Docker Engine v1.7+</a></li><li><a href="https://axibase.com/docs/atsd/installation/docker.html" target="_blank" rel="noopener noreferrer">Axibase Time Series Database</a> container as a centralized metrics store and rule engine.</li></ul><h2 id="local-installation"><a href="#local-installation" aria-hidden="true" class="header-anchor">#</a> Local Installation</h2><p>In local collection mode, Axibase Collector containers run on each Docker host and gather statistics locally from the Docker engine API exposed at the <a href="https://docs.docker.com/engine/reference/api/docker_remote_api/" target="_blank" rel="noopener noreferrer">/var/run/docker.sock</a> Unix socket.</p><p><img src="/axibase-collector/assets/img/docker-local.18937084.png" alt="Local Collection"></p><ul><li>Create a <a href="https://axibase.com/docs/atsd/administration/collector-rw-account.html" target="_blank" rel="noopener noreferrer">collector account</a> in ATSD.</li><li>Replace <code>atsd_host</code> and <code>atsd_https_port</code> with the ATSD hostname/IP address and https port (default 8443).</li><li>Replace <code>collector-rw</code> and <code>collector-password</code> with valid credentials in the script below.</li><li>Start Axibase Collector container:</li></ul><pre class="language-properties"><code><span class="token attr-name">docker</span> <span class="token attr-value">run \
   --detach \
   --publish-all \
   --restart=always \
   --name=axibase-collector \
   --volume /var/run/docker.sock:/var/run/docker.sock \
   --env=DOCKER_HOSTNAME=`hostname -f` \
  axibase/collector \
   -atsd-url=https://collector-rw:collector-password@atsd_host:atsd_https_port \
   -job-enable=docker-socket</span>
</code></pre><p>If the user name or password contains <code>$</code>, <code>&amp;</code>, <code>#</code>, or <code>!</code> character, escape it with backslash <code>\</code>.</p><p>The password must contain at least <strong>six</strong> (6) characters and is subject to the following <a href="https://axibase.com/docs/atsd/administration/user-authentication.html#password-requirements" target="_blank" rel="noopener noreferrer">requirements</a>.</p><p>For example, for user <code>adm-dev</code> with password <code>my$pwd</code> sending data to ATSD at <code>https://10.102.0.6:8443</code> specify:</p><pre class="language-properties"><code><span class="token attr-name">docker</span> <span class="token attr-value">run \
   --detach \
   --publish-all \
   --restart=always \
   --name=axibase-collector \
   --volume /var/run/docker.sock:/var/run/docker.sock \
   --env=DOCKER_HOSTNAME=`hostname -f` \
  axibase/collector \
   -atsd-url=https://adm-dev:my\$pwd@10.102.0.6:8443 \
   -job-enable=docker-socket</span>
</code></pre><p>It may take up to 5 minutes to initialize the Collector's database upon initial startup.</p><p>The Docker job should start executing immediately.</p><h3 id="selinux"><a href="#selinux" aria-hidden="true" class="header-anchor">#</a> SELinux</h3><p>On Docker hosts with SELinux enabled in enforced mode, the container will run into a <code>permission denied</code> error when trying to read data from  <code>/var/run/docker.sock</code>.</p><p>Switch to the Remote Collection option or follow one of the following steps to address it:</p><ul><li><p>Run container in privileged mode (<code>--privileged</code>)</p></li><li><p>Run container with disabled security labeling (<code>--security-opt label=disable</code>)</p></li><li><p>Disable SELinux or set it into logging mode with <code>sudo setenforce Permissive</code></p></li><li><p>Other alternatives using <a href="https://github.com/dpw/selinux-dockersock" target="_blank" rel="noopener noreferrer"><code>semodule</code></a></p></li><li><p><strong>Launch Parameters</strong></p></li></ul><table><thead><tr><th><strong>Name</strong></th><th><strong>Required</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td><code>--detach</code></td><td>Yes</td><td>Run container in background and print container id.</td></tr><tr><td><code>--name</code></td><td>No</td><td>Assign a host-unique name to the container.</td></tr><tr><td><code>--restart</code></td><td>No</td><td>Auto-restart policy. <em>Not supported in all Docker Engine versions.</em></td></tr><tr><td><code>--publish-all</code></td><td>No</td><td>Publish all exposed ports to random ports.</td></tr><tr><td><code>--env</code></td><td>No</td><td>Set environment variables.</td></tr></tbody></table><h2 id="remote-collection"><a href="#remote-collection" aria-hidden="true" class="header-anchor">#</a> Remote Collection</h2><p>In remote collection mode Axibase Collector fetches data from multiple remote Docker hosts using https protocol.</p><p><img src="/axibase-collector/assets/img/docker-remote.cd26fdd3.png" alt="Local Collection"></p><h3 id="enable-remote-api-access-on-docker-hosts"><a href="#enable-remote-api-access-on-docker-hosts" aria-hidden="true" class="header-anchor">#</a> Enable Remote API Access on Docker Hosts</h3><ul><li><p>Log in to the Docker host via SSH and generate <a href="/axibase-collector/jobs/docker-certificates.html">client and server certificates</a>.</p></li><li><p>Configure the Docker daemon for secure access over HTTPS.</p><p><strong>On Ubuntu 14.04</strong></p><ul><li><p>Edit the <code>/etc/default/docker</code> file</p><pre class="language-text"><code># Set path to the folder containing {ca,server-cert,server-key}.pem files
DOCKER_CERT_PATH=/home/user/certs
export DOCKER_CERT_PATH

# Add TCP socket on port 2376
DOCKER_OPTS=&quot;--tlsverify --tlscacert=$DOCKER_CERT_PATH/ca.pem --tlscert=$DOCKER_CERT_PATH/server-cert.pem --tlskey=$DOCKER_CERT_PATH/server-key.pem -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2376&quot;
</code></pre></li><li><p>Restart the Docker daemon.</p><pre class="language-text"><code>sudo service docker restart
</code></pre></li></ul></li><li><p><strong>On Ubuntu 16.04, Centos 7.x and RHEL 7.x</strong></p><ul><li><p>Create new socket unit.</p><pre class="language-text"><code>echo &lt;&lt;EOF &gt; /lib/sytemd/system/docker-tcp.socket
[Unit]
Description=Docker TCP Socket for the API

[Socket]
ListenStream=2376
Service=docker.service

[Install]
WantedBy=sockets.target
EOF
</code></pre></li><li><p>Edit <code>/etc/docker/daemon.json</code> file by adding the options below. Replace <code>/home/user/certs</code> with absolute path of previously created <code>certs</code> directory.</p><pre class="language-text"><code>{
  ...,
  &quot;tlscacert&quot;: &quot;/home/user/certs/ca.pem&quot;,
  &quot;tlscert&quot;: &quot;/home/user/certs/server-cert.pem&quot;,
  &quot;tlskey&quot;: &quot;/home/user/certs/server-key.pem&quot;,
  &quot;tlsverify&quot;: true
}
</code></pre></li><li><p>Stop the Docker daemon and activate the socket.</p><pre class="language-text"><code>systemctl enable docker-tcp.socket
systemctl stop docker
systemctl start docker-tcp.socket
</code></pre></li><li><p>Check that the socket has been successfully activated.</p><pre class="language-text"><code>systemctl status docker-tcp.socket
</code></pre><p>Output example:</p><pre class="language-text"><code>● docker-tcp.socket - Docker TCP Socket for the API
  Loaded: loaded (/lib/systemd/system/docker-tcp.socket; enabled; vendor preset: enabled)
  Active: active (running) since Sat 2018-03-03 18:54:32 CET; 2min ago
  Listen: [::]:2376 (Stream)

Mar 03 18:54:32 localhost systemd[1]: Listening on Docker TCP Socket for the API.
</code></pre></li><li><p>Start the Docker daemon.</p><pre class="language-text"><code>systemctl start docker
</code></pre></li><li><p>Ensure that the Docker daemon status is <em>active</em> and there are no warnings.</p><pre class="language-text"><code>systemctl status docker
</code></pre></li></ul></li><li><p>Verify connectivity.</p><pre class="language-text"><code>curl https://127.0.0.1:2376/info     \
    --cert /home/user/certs/cert.pem \
    --key /home/user/certs/key.pem   \
    --cacert /home/user/certs/ca.pem
</code></pre></li><li><p>Copy the <code>{ca,cert,key}.pem</code> files to your machine.</p></li></ul><h3 id="launch-axibase-collector-container"><a href="#launch-axibase-collector-container" aria-hidden="true" class="header-anchor">#</a> Launch Axibase Collector Container</h3><ul><li><p>Create a <a href="https://axibase.com/docs/atsd/administration/collector-rw-account.html" target="_blank" rel="noopener noreferrer">collector account</a> in ATSD.</p></li><li><p>Start Axibase Collector container, replacing <code>collector-rw</code> and <code>collector-password</code> with valid credentials:</p></li></ul><pre class="language-properties"><code><span class="token attr-name">docker</span> <span class="token attr-value">run \
   --detach \
   --publish-all \
   --name=axibase-collector \
  axibase/collector \
   -atsd-url=https://collector-rw:collector-password@atsd_host:atsd_https_port</span>
</code></pre><p>If the user name or password contains a <code>$</code>, <code>&amp;</code>, <code>#</code>, or <code>!</code> character, escape it with backslash <code>\</code>.</p><p>The password must contain at least <strong>6</strong> characters and is subject to the following <a href="https://axibase.com/docs/atsd/administration/user-authentication.html#password-requirements" target="_blank" rel="noopener noreferrer">requirements</a>.</p><ul><li>Find the https port assigned to the <code>axibase-collector</code> container.</li></ul><pre class="language-text"><code>docker ps -a | grep axibase-collector
</code></pre><ul><li>Log in to the Axibase Collector web interface at <code>https://hostname:port</code>.</li><li>Open the <strong>Jobs &gt; Docker &gt; Add Job</strong> page and enter the job name. Click <strong>Enabled</strong> to enable the job. Click Save.</li><li>Click the [Use Wizard] button, specify the Docker Engine hostname, API port (2376), and attach <code>{cert,key,ca}.pem</code> files.</li><li>Click Validate and then Save if the test is successful.</li></ul><h2 id="validation"><a href="#validation" aria-hidden="true" class="header-anchor">#</a> Validation</h2><p>Log in to ATSD and verify that connected Docker hosts are displayed on the 'Entities: Docker Hosts' page.</p><p>If the Docker host is missing in ATSD, open the 'Jobs' page in Collector, check the <strong>Result</strong> column, and review the <strong>Execution Details</strong> page for any errors.</p><h2 id="container-launch-troubleshooting"><a href="#container-launch-troubleshooting" aria-hidden="true" class="header-anchor">#</a> Container Launch Troubleshooting</h2><pre class="language-text"><code>docker exec -it axibase-collector tail -f /opt/axibase-collector/logs/axibase-collector.log
</code></pre><p>The following message indicates that the initial configuration is finished:</p><blockquote><p>FrameworkServlet 'dispatcher': initialization completed.</p></blockquote><h2 id="ui"><a href="#ui" aria-hidden="true" class="header-anchor">#</a> UI</h2><p>Verify the https port that is assigned to the collector and open it in your browser: <code>https://container-ip:port</code></p><pre class="language-text"><code>docker ps | grep axibase-collector
</code></pre><p>Locate the <strong>docker-socket</strong> job on the 'Jobs' list and verify that it is enabled and that the <code>Items Read</code> column is not 0.</p><h2 id="testing-and-evaluating"><a href="#testing-and-evaluating" aria-hidden="true" class="header-anchor">#</a> Testing and Evaluating</h2><p>You can launch both the <strong>atsd</strong> and <strong>axibase-collector</strong> containers in a <a href="/axibase-collector/jobs/docker-compose.html">test environment</a> using  <code>docker-compose</code>.</p></div><div class="content edit-link"><a href="https://github.com/axibase/axibase-collector/edit/master//jobs/docker.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div></div></div>
    <script src="/axibase-collector/assets/js/99.5d98ccc1.js" defer></script><script src="/axibase-collector/assets/js/app.7b3887e4.js" defer></script>
  </body>
</html>
