<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Collector | Monitoring Docker Volume Usage</title>
    <meta name="description" content="User manual and API reference for AxibaseÂ® Time Series Database">
    <link rel="shortcut icon" href="axibase-collectorfavicon.ico">
    
    <link rel="stylesheet" href="axibase-collector/assets/css/117.styles.e57454c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/axibase-collector/" class="home-link router-link-active"><img src="axibase-collectorimages/axibase_logo_green.gif" class="logo"><span class="site-name can-hide">
      Collector
    </span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Jobs</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/aws.html" class="nav-link">AWS</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/docker.html" class="nav-link">Docker</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/file.html" class="nav-link">File</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http.html" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/icmp.html" class="nav-link">ICMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc.html" class="nav-link">JDBC</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jmx.html" class="nav-link">JMX</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/json.html" class="nav-link">JSON</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/ovpm.html" class="nav-link">OVPM</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/pi.html" class="nav-link">PI</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/snmp.html" class="nav-link">SNMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/socrata.html" class="nav-link">Socrata</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/tcp.html" class="nav-link">TCP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Data Sources</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc-data-source.html" class="nav-link">Database</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/atsd-server-connection.html#http-pool" class="nav-link">HTTP Pool</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka-consumer.html" class="nav-link">Kafka Consumer</a></li></ul></div></div><div class="nav-item"><a href="/axibase-collector/#examples" class="nav-link">Examples</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Jobs</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/aws.html" class="nav-link">AWS</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/docker.html" class="nav-link">Docker</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/file.html" class="nav-link">File</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/http.html" class="nav-link">HTTP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/icmp.html" class="nav-link">ICMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc.html" class="nav-link">JDBC</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jmx.html" class="nav-link">JMX</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/json.html" class="nav-link">JSON</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka.html" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/ovpm.html" class="nav-link">OVPM</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/pi.html" class="nav-link">PI</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/snmp.html" class="nav-link">SNMP</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/socrata.html" class="nav-link">Socrata</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/tcp.html" class="nav-link">TCP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Data Sources</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/jdbc-data-source.html" class="nav-link">Database</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/atsd-server-connection.html#http-pool" class="nav-link">HTTP Pool</a></li><li class="dropdown-item"><!----><a href="/axibase-collector/jobs/kafka-consumer.html" class="nav-link">Kafka Consumer</a></li></ul></div></div><div class="nav-item"><a href="/axibase-collector/#examples" class="nav-link">Examples</a></div><!----></nav><ul class="sidebar-links"><li><a href="/axibase-collector/" class="sidebar-link">Axibase Collector</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Installation</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Updating</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Administration</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Job's Configuration</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Automation</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="monitoring-docker-volume-usage"><a href="#monitoring-docker-volume-usage" aria-hidden="true" class="header-anchor">#</a> Monitoring Docker Volume Usage</h1><h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2><p>Monitoring disk space usage with a breakdown by individual container ensures continuous service availability by preventing space leakages in containers with data (persistent) volumes.</p><p>While the Docker <a href="https://docs.docker.com/engine/reference/commandline/ps/" target="_blank" rel="noopener noreferrer">command line</a> provides a way to obtain container sizes using the <code>--size</code> flag, the command may take <a href="https://github.com/docker/docker/issues/17832" target="_blank" rel="noopener noreferrer">several minutes</a> to complete while significantly overloading the host's disk subsystem and slowing down Docker Engine API response times. Besides, the CLI output doesn't expose space usage by volume and requires parsing size units (kb, mb, gb).</p><pre class="language-text"><code>axibase@NURSWGHBS001:~$ docker ps -s --format &quot;{{.ID}}\t{{.Names}}\t{{.Size}}&quot;
</code></pre><pre class="language-text"><code>a832af264060 JENKINS_atsd-api-test_ 132.3 kB (virtual 984.1 MB)
d7f87797f36e distracted_williams 323 MB (virtual 1.821 GB)
f53cf366a4c6 stupefied_hamilton 323 MB (virtual 1.821 GB)
d6d362779455 sad_spence 446.5 MB (virtual 1.944 GB)
fa510d6c9a9a ve-7.1.1 1.518 GB (virtual 2.244 GB)
75caaa907eab axibase_collector 5.942 GB (virtual 20.38 GB)
...
</code></pre><p>For example, on a Docker host where the <code>/var/lib/docker</code> size is 30Gb with 20 running containers and 80 in total, the initial execution of the <code>docker ps -as</code> command takes more than 2 minutes while fully loading the host's I/O.</p><pre class="language-text"><code>axibase@NURSWGHBS001:~$ time docker ps -as
CONTAINER ID   IMAGE                             COMMAND                  CREATED         STATUS         PORTS                     SIZE
83010924db3c   axibase/atsd_package_validation   &quot;/bin/bash /root/chec&quot;   5 minutes ago   Up 3 minutes   atsd_package_validation   561.7 MB (virtual 818.9 MB)
...
real 2m51.218s
user 0m0.026s
sys 0m0.032s
</code></pre><p><img src="docker-ps-as.png" alt="docker-ps"></p><p>Executing API requests with the <code>&amp;size=1</code> parameter typically requires even more time than the <code>docker ps -as</code> command and may cause timeout issues for API clients.</p><h2 id="collecting-container-sizes-with-axibase-collector"><a href="#collecting-container-sizes-with-axibase-collector" aria-hidden="true" class="header-anchor">#</a> Collecting Container Sizes with Axibase Collector</h2><p>To gather container sizes using Axibase Collector, set <strong>Container Size Interval</strong> to an interval 60 minutes or longer.</p><p>To minimize the load on the disk subsystem, this interval will be applied to running containers, while the size of inactive containers will be collected less frequently, as specified by the Property Interval.</p><h3 id="container-size-metrics"><a href="#container-size-metrics" aria-hidden="true" class="header-anchor">#</a> Container Size Metrics</h3><p>Axibase Collector collects sizes for both individual containers as well as the total for running and all containers.</p><table><thead><tr><th><strong>Metric Name</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>docker.fs.size.rw</td><td>The total size of all the files in the container, in bytes. If you were to export the filesystem of the container as a tarball, it would be about that size.</td></tr><tr><td>docker.fs.size.rootfs</td><td>The size of the files which have been created or changed, if you compare the container to its base image. Just after creation, this should be zero; as you modify (or create) files, this will increase</td></tr><tr><td>docker.fs.total.size.rw</td><td>The total size of all the files for all containers, in bytes. Î£ docker.fs.size.rw for all containers.</td></tr><tr><td>docker.fs.total.size.rootfs</td><td>The size of the files which have been created or changed for all containers. Î£ docker.fs.size.rootfs for all containers.</td></tr><tr><td>docker.fs.running.size.rw</td><td>The total size of all the files for all running containers, in bytes. Î£ docker.fs.size.rw for running containers.</td></tr><tr><td>docker.fs.running.size.rootfs</td><td>The size of the files which have been created or changed for running containers. Î£ docker.fs.size.rootfs for running containers.</td></tr></tbody></table><p><a href="https://apps.axibase.com/chartlab/81932cd6/2/" target="_blank" rel="noopener noreferrer">Chartlab example</a></p><h2 id="du-alternative"><a href="#du-alternative" aria-hidden="true" class="header-anchor">#</a><code>du</code> Alternative</h2><p>One of the &quot;lesser evil&quot; alternatives is to calculate disk usage of <code>/var/lib/docker</code> subdirectories using the <code>ds</code> command. This requires superuser privileges.</p><pre class="language-text"><code>sudo bash -c 'du -hs /var/lib/docker/volumes/*'
</code></pre><blockquote><p>Note: We're using the <code>bash -c</code> wrapper here as a permission-safe way to pass the * wildcard.</p></blockquote><pre class="language-text"><code>177M /var/lib/docker/volumes/dd1e8b1942e204054b8a56219e523834d35bd8e84283720daf227823eae9b21f
174M /var/lib/docker/volumes/de9a1746ea49e702accfb732ee74354c6291c2356a5319693868533fbeb40765
363M /var/lib/docker/volumes/df81a9b753aa9464935af03b8e3dc57fa53cacaa1910a80dc4f1e6b9f952fb77
1.7G /var/lib/docker/volumes/df8948c840a882070c9ed10f01bf3c6b594a0095f236f47af124cf9d76dee165
1.1G /var/lib/docker/volumes/e1f9859a2a58a8071805597e3e4ea71d45e67cda13dbb9630742e654c379d544
307M /var/lib/docker/volumes/eb3952dec29e293cfae8149b20c40859ac944723abd28666e093ab1d76b43a0c
</code></pre><p>The following <a href="docker_volume_collect.sh">collector</a> script executes the <code>ds</code> command to calculate total disk usage of each subdirectory in the <code>/var/lib/docker/volumes/</code> directory, as well as computes the percentage of the total size of the underlying file system, used by each volume.</p><h3 id="running"><a href="#running" aria-hidden="true" class="header-anchor">#</a> Running</h3><ul><li><p>Print commands to stdout:</p><pre class="language-text"><code>sudo ./docker_volume_collect.sh
</code></pre></li><li><p>Print commands to file:</p><pre class="language-text"><code>sudo ./docker_volume_collect.sh &gt;&gt; /tmp/docker-volumes.out
</code></pre></li><li><p>Send commands to ATSD:</p><pre class="language-text"><code>sudo ./docker_volume_collect.sh &gt; /dev/tcp/{atsd_hostname}/8081
</code></pre></li></ul><h3 id="sample-commands"><a href="#sample-commands" aria-hidden="true" class="header-anchor">#</a> Sample commands</h3><pre class="language-text"><code>series e:f867330fd3e9f103388ed84325c4432a4dce2cdebfb7db22f46940bcecc81225 m:docker.volume.used=179724 d:2016-12-27T11:12:39Z t:docker-host=&quot;nurswghbs001&quot;
series e:f867330fd3e9f103388ed84325c4432a4dce2cdebfb7db22f46940bcecc81225 m:docker.volume.used_percent=0.0175442 d:2016-12-27T11:12:39Z t:docker-host=&quot;nurswghbs001&quot;
series e:nurswghbs001 m:docker.volume.total_used=32424032 d:2016-12-27T11:12:39Z
series e:nurswghbs001 m:docker.volume.total_used_percent=3.16514 d:2016-12-27T11:12:39Z
</code></pre><h3 id="scheduling"><a href="#scheduling" aria-hidden="true" class="header-anchor">#</a> Scheduling</h3><ul><li><p>To send commands to ATSD on schedule, open crontab:</p><pre class="language-text"><code>su root
crontab -e
</code></pre></li><li><p>Add the task to collect data every 15 minutes:</p><pre class="language-text"><code>*/15 * * * * /bin/bash -l -c '/opt/scripts/docker_volume_collect.sh &gt; /dev/tcp/{atsd_hostname}/8081'
</code></pre></li></ul><h2 id="container-volume-metrics"><a href="#container-volume-metrics" aria-hidden="true" class="header-anchor">#</a> Container Volume Metrics</h2><table><thead><tr><th><strong>Metric Name</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>docker.volume.fs.size</td><td>Total size (used + available, in bytes) of the file system where the <code>/var/lib/docker</code> directory is located. Collected for the entire docker host.</td></tr><tr><td>docker.volume.total_used</td><td>Total space (in bytes) used by the <code>/var/lib/docker</code> directory. Collected for the entire docker host.</td></tr><tr><td>docker.volume.total_used_percent</td><td>Percentage of space used by the <code>/var/lib/docker</code> directory in the file system where the <code>/var/lib/docker</code> directory is located. Calculated as docker.volume.total_used/docker.volume.fs.size * 100. Collected for the entire docker host.</td></tr><tr><td>docker.volume.used</td><td>Space used by all files in the given volume (in bytes).</td></tr><tr><td>docker.volume.used_percent</td><td>Space used by files in the given volume as percentage of the total size of the file system where the <code>/var/lib/docker</code> directory is located. Calculated as docker.volume.used/docker.volume.fs.size * 100.</td></tr></tbody></table><h2 id="volume-view"><a href="#volume-view" aria-hidden="true" class="header-anchor">#</a> Volume View</h2><p>To display volume sizes, import the <a href="volume-entity-view.xml">updated Entity View</a> for Docker Volumes via ATSD -&gt; [Configuration] -&gt; Entity Views -&gt; [Import] with the 'Replace Existing Entity Views' option enabled.</p><p><img src="volume-view.png" alt="volume-view"></p><h2 id="volume-disk-rules"><a href="#volume-disk-rules" aria-hidden="true" class="header-anchor">#</a> Volume Disk Rules</h2><p>Import the <a href="volume-rules.xml">rules</a> file to raise an alert whenever a volume consumes more than 50% of total file system size.</p><table><thead><tr><th>Rule Name</th><th>Description</th></tr></thead><tbody><tr><td>docker-host-volume-space-low</td><td>Raise an alert if the total size of the <code>/var/lib/docker</code> directory exceeds 60% of the total space on the file system.</td></tr><tr><td>docker-volume-space-leak</td><td>Raise an alert if the volume consumes more than 25% of the total space on the file system where <code>/var/lib/docker</code> is located.</td></tr></tbody></table><h2 id="monitor-volume-sizes-using-a-container"><a href="#monitor-volume-sizes-using-a-container" aria-hidden="true" class="header-anchor">#</a> Monitor Volume Sizes using a Container</h2><p>As an alternative to running the above <code>du</code> script on the Docker host, you can launch an Axibase Collector container with the <code>/var/lib/docker/volumes</code> directory mounted in read-only mode.</p><ul><li><p>Replace the <code>atsd_host</code> placeholder with the actual ATSD hostname in the command below.</p></li><li><p>Replace <code>collector-user</code> and <code>collector-password</code> with <a href="https://axibase.com/docs/atsd/administration/collector-account.html" target="_blank" rel="noopener noreferrer">collector account</a> credentials.</p><pre class="language-properties"><code><span class="token attr-name">docker</span> <span class="token attr-value">run \
  --detach \
  --publish-all \
  --restart=always \
  --name=axibase-collector \
  --volume /var/lib/docker/volumes:/var/lib/docker/volumes:ro \
  axibase/collector \
   -atsd-url=https://collector-user:collector-password@atsd_host:8443 \
   -job-enable=docker-socket</span>
</code></pre></li><li><p>Start the container.</p></li><li><p>Copy the script into the container.</p><p>Here, there are two alternatives:</p><p>a) Copy the script file to the Docker host and then copy the file into the container:</p><pre class="language-text"><code>docker cp /tmp/docker_volume_collect.sh axibase-collector:/opt/axibase-collector/ext/docker_volume_collect.sh
</code></pre><p>b) Download the script file directly into the container:</p><pre class="language-text"><code>docker exec axibase-collector wget https://raw.githubusercontent.com/axibase/axibase-collector/master/jobs/docker/docker_volume_collect.sh -P /opt/axibase-collector/ext
</code></pre></li><li><p>Grant <code>execute</code> permissions to the script:</p><pre class="language-text"><code>docker exec axibase-collector chmod +x  /opt/axibase-collector/ext/docker_volume_collect.sh
</code></pre></li><li><p>Run the script once manually to validate ingestion:</p><pre class="language-text"><code>docker exec axibase-collector /opt/axibase-collector/ext/docker_volume_collect.sh docker_hostname tcp://atsd_host:8081
</code></pre></li><li><p>Login in to ATSD and verify that the following metrics are available:</p><pre><code>  docker.volume.fs.size
  docker.volume.total_used
  docker.volume.total_used_percent
  docker.volume.used
  docker.volume.used_percent
</code></pre></li><li><p>Open the cron file in the container shell:</p><pre class="language-text"><code>docker exec -it axibase-collector crontab -e
</code></pre></li><li><p>Add the following lines to cron schedule:</p><pre class="language-text"><code># Replace 'docker_hostname' with the hostname of the Docker host
# Replace 'atsd_host' with ATSD hostname or IP address
# Run script every 15 minutes
*/15 * * * * /opt/axibase-collector/ext/docker_volume_collect.sh docker_hostname tcp://atsd_host:8081
# Empty line is required at the end of this file for a valid cron file
</code></pre></li><li><p>Save the cron file.</p></li></ul></div><div class="content edit-link"><a href="https://github.com/axibase/axibase-collector/edit/master//jobs/docker/volume-size.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div></div></div>
    <script src="axibase-collector/assets/js/95.bb483680.js" defer></script><script src="axibase-collector/assets/js/app.69079531.js" defer></script>
  </body>
</html>
